<!DOCTYPE html>
<html lang="en">
<head>
    <title>评价详情</title>
    <meta charset="utf-8">
    <meta content="true" name="HandheldFriendly">
    <meta content="yes" name="apple-touch-fullscreen">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="width=device-width,target-densitydpi=device-dpi, user-scalable=0" name="viewport">
    <link href="css/style.css" rel="stylesheet">
    <link href="mescroll/mescroll.min.css" rel="stylesheet">
    <meta content="模型APP内测招募" property="title"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="description"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="keywords"/>
    <meta content="https://www.2501p.com/img/share_logo.jpg" property="image"/>

    <meta content="模型APP内测招募" property="og:title"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="og:description"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="og:keywords"/>
    <meta content="https://www.2501p.com/img/share_logo.jpg" property="og:image"/>
    <style type="text/css">
        /*列表*/
        .mescroll {
            position: fixed;
            top: 619px;
            bottom: 0px;
            height: auto;
        }

        .data-list li {
            position: relative;
            padding: 10px 8px 10px 120px;
            border-bottom: 1px solid #eee;
        }
    </style>

    <script type="text/javascript">
        if (/Android (\d+\.\d+)/.test(navigator.userAgent)) {
            const version = parseFloat(RegExp.$1);
            if (version > 2.3) {
                const phoneScale = window.screen.width / 750;
                document.write('<meta name="viewport" content="width=750, minimum-scale = ' + phoneScale + ', maximum-scale = ' + phoneScale + ', target-densitydpi=device-dpi">');
            } else {
                document.write('<meta name="viewport" content="width=, target-densitydpi=device-dpi">');
            }
        } else {
            document.write('<meta name="viewport" content="width=750, user-scalable=no">');
        }
    </script>
    <script src="js/jquery-3.4.1.min.js" type="text/javascript"></script>
</head>
<body>
<div id="evaluate">

    <div id="content">
        <div class="uesMsg">
            <div class="useDetail">
                <div class="head"></div>
                <div class="use_box">
                    <p class="name"></p>
                    <div class="evaluateMsg">
                        <p class="evaluateNum">评价 <span></span></p>
                        <p class="general">好评率 <span></span>%</p>
                    </div>
                </div>
            </div>

            <table id="statistics">
                <tr>
                    <th></th>
                    <th>最近1周</th>
                    <th>最近1月</th>
                    <th>最近6月</th>
                </tr>
                <!--<tr><td></td><td>123</td><td>456</td><td>789</td></tr>-->
            </table>
        </div>

        <div class="line"></div>
        <div class="bidMsg">
            <ol>
                <li class="hover" data-type="ALL">全部</li>
                <li data-type="PICTURE">有图</li>
                <li data-type="PRAISE">好评</li>
                <li data-type="AVERAGE">中评</li>
                <li data-type="NEGATIVE">差评</li>
            </ol>
            <div class="mescroll" id="mescroll">
                <div id="dataList">
                    <ul>
                        <li>
                            <div class="head"><img alt="" src="img/detail/head_img.png"></div>
                            <div class="use_box">
                                <p class="name">呆毛王阿尔托莉雅</p>
                                <div class="evaluateMsg">
                                    <p class="evaluateNum">评价 <span>9999</span></p>
                                    <p class="general">好评率 <span>99</span>%</p>
                                    <p class="grand color3"><img alt="" src="img/detail/evaluate_ico3.png">差评</p>
                                </div>
                            </div>
                        </li>
                        <p class="productName">商品名称商品名称商品名称商品名称</p>
                        <p class="text">留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言留言...</p>
                        <div class="time">
                            <span>2019-05-12</span>
                            <span>22:25:35</span>
                        </div>
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
<script src="mescroll/mescroll.min.js" type="text/javascript"></script>
<script src="js/common.js" type="text/javascript"></script>
<script type="text/javascript">
    shareMsg(); //分享


    let sellerId = getQueryStringByName('sellerID');
    let evalType = 'ALL';
    let sellerData;

    // 获取评价详情
    getEvaluationDetails();

    /**
     * 获取评价详情
     */
    function getEvaluationDetails() {
        $.ajax({
            url: link + '/rating/sellers/' + sellerId,
            type: 'GET',
            data: {
                requestId: md5(sellerId),
                timestamp: new Date().getTime(),
            }
        }).done(function (response) {
            console.log(response);

            handler({
                res: response,
                fun1: function () {
                    sellerData = response.data;

                    setUseDetailHTML();

                    setStatisticsHTML();
                }
            })
        });
    }

    function setUseDetailHTML() {
        let useDetailHTML = '';
        useDetailHTML += '<div class="head">' + headImgHtml(sellerData.avatarPath) + '</div>';
        useDetailHTML += '<div class="use_box">';
        useDetailHTML += '    <p class="name">' + userName(sellerData.username) + '</p>';
        useDetailHTML += '    <div class="evaluateMsg">';
        useDetailHTML += '        <p class="evaluateNum">评价 <span>' + sellerData['totalNumber'] + '</span></p>';
        useDetailHTML += '        <p class="general">好评率 <span>' + sellerData['praiseRate'] + '</span>%</p>';
        useDetailHTML += '    </div>';
        useDetailHTML += '</div>';
        $('.useDetail').html(useDetailHTML);
    }

    function setStatisticsHTML() {
        let statisticsHTML = '';
        statisticsHTML += '<tr><th></th><th>最近1周</th><th>最近1月</th><th>最近6月</th></tr>';
        statisticsHTML += '<tr><td>好评<img src="img/detail/evaluate_ico1.png" alt=""></td><td>' + sellerData['praiseNumber1'] + '</td><td>' + sellerData['praiseNumber2'] + '</td><td>' + sellerData['praiseNumber3'] + '</td></tr>';
        statisticsHTML += '<tr><td>中评<img src="img/detail/evaluate_ico2.png" alt=""></td><td>' + sellerData['averageNumber1'] + '</td><td>' + sellerData['averageNumber2'] + '</td><td>' + sellerData['averageNumber3'] + '</td></tr>';
        statisticsHTML += '<tr><td>差评<img src="img/detail/evaluate_ico3.png" alt=""></td><td>' + sellerData['negativeNumber1'] + '</td><td>' + sellerData['negativeNumber2'] + '</td><td>' + sellerData['negativeNumber3'] + '</td></tr>';
        $('#statistics').html(statisticsHTML);
    }

    /**
     * 下拉加载获取评价列表
     */
    const mescroll = new MeScroll('mescroll', {
        up: {
            callback: upCallback, //上拉回调,此处可简写; 相当于 callback: function (page) { getListData(page); }
            isBounce: false, //此处禁止ios回弹,解析(务必认真阅读,特别是最后一点): http://www.mescroll.com/qa.html#q10
            clearEmptyId: 'dataList', //1.下拉刷新时会自动先清空此列表,再加入数据; 2.无任何数据时会在此列表自动提示空
            toTop: { //配置回到顶部按钮
                src: '../res/img/mescroll-totop.png', //默认滚动到1000px显示,可配置offset修改
            }
        }
    });

    /**
     * 上拉加载的回调 page = {num:1, size:10}; num:当前页 默认从1开始, size:每页数据条数,默认10
     */
    function upCallback(page) {
        let ajaxData = {
            pageNumber: page.num,
            pageSize: page.size,
            sellerId: sellerId,
            evalType: evalType
        };

        ajaxData.requestId = md5(JSON.stringify(ajaxData));
        ajaxData.timestamp = new Date().getTime();
        $.ajax({
            url: link + '/goods/evaluates',
            type: 'GET',
            data: ajaxData
        }).done(function (response) {
            console.log(response);

            handler({
                res: response,
                fun1: function () {
                    let curPageData = response.data; // 接口返回的当前页数据列表
                    let totalSize = response.count; // 接口返回的总数据量(比如列表有26个数据,每页10条,共3页; 则totalSize值为26)
                    mescroll.endSuccess(curPageData.length, totalSize);

                    setListData(curPageData)
                }
            })
        })
    }

    function setListData(curPageData) {
        let dataListHTML = '';

        for (let i = 0; i < curPageData.length; i++) {
            let curData = curPageData[i];

            let evaluateLevelHTML = '';
            if ('PRAISE' === curData['buyerLevel']) {
                evaluateLevelHTML = '<img src="img/detail/evaluate_ico1.png" alt="">好评';
            } else if ('AVERAGE' === curData['buyerLevel']) {
                evaluateLevelHTML = '<img src="img/detail/evaluate_ico2.png" alt="">中评';
            } else if ('NEGATIVE' === curData['buyerLevel']) {
                evaluateLevelHTML = '<img src="img/detail/evaluate_ico3.png" alt="">差评';
            }

            let evaluateImageHTML = '';
            if (curData['linkAddress']) {
                let imageArray = curData['linkAddress'].split(";");
                for (let j = 0; j < imageArray.length; j++) {
                    evaluateImageHTML += '<div class="img"><img class="imgwidth" src="' + link + imageArray[j] + '" alt=""></div>';
                }
            }

            dataListHTML += '<ul>';
            dataListHTML += '    <li>';
            dataListHTML += '        <div class="head"><img src="img/head.png" alt="" style="width: 100%;"></div>';
            dataListHTML += '        <div class="use_box">';
            dataListHTML += '            <p class="name">' + userName(curData['username']) + '</p>';
            dataListHTML += '            <div class="evaluateMsg">';
            dataListHTML += '                <p class="evaluateNum">评价 <span>' + curData['totalNumber'] + '</span></p>';
            dataListHTML += '                <p class="general">好评率 <span>' + curData['praiseRate'] + '</span>%</p>';
            dataListHTML += '                <p class="grand color3">' + evaluateLevelHTML + '</p>';
            dataListHTML += '            </div>';
            dataListHTML += '        </div>';
            dataListHTML += '    </li>';
            dataListHTML += '    <p class="productName">' + curData['title'] + '</p>';
            dataListHTML += '    <p class="text">' + (curData['content'] || '此用户没有留下文字评论') + '</p>';
            dataListHTML += '    <div class="img_box">' + evaluateImageHTML + '</div>';
            dataListHTML += '    <div class="time">';
            dataListHTML += '        <span>' + curData['createTime'] + '</span>';
            dataListHTML += '    </div>';
            dataListHTML += '</ul>';
        }
        $('#dataList').append(dataListHTML);
    }

    /**
     * 切换评价类型
     */
    $('.bidMsg ol').on('click', 'li', function () {
        evalType = $(this).data('type');

        $(".bidMsg ol li").removeClass('hover');
        $(this).addClass('hover');

        //重置列表数据
        mescroll.resetUpScroll();
    });
</script>
</body>
</html>