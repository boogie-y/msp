<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="yes" name="apple-touch-fullscreen">
    <meta content="true" name="HandheldFriendly">
    <meta content="width=device-width,target-densitydpi=device-dpi, user-scalable=0" name="viewport">
    <title></title>
    <link href="css/style.css" rel="stylesheet">
    <!--上拉加载css-->
    <link href="mescroll/mescroll.min.css" rel="stylesheet">
    <meta content="模型APP内测招募" property="title"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="description"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="keywords"/>
    <meta content="https://www.2501p.com/img/share_logo.jpg" property="image"/>

    <meta content="模型APP内测招募" property="og:title"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="og:description"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="og:keywords"/>
    <meta content="https://www.2501p.com/img/share_logo.jpg" property="og:image"/>
    <style type="text/css">
        .mescroll {
            position: fixed;
            top: 176px;
            bottom: 0;
            height: auto;
        }

        .data-list li {
            position: relative;
            padding: 10px 8px 10px 120px;
            border-bottom: 1px solid #eee;
        }
    </style>

    <script type="text/javascript">
        if (/Android (\d+\.\d+)/.test(navigator.userAgent)) {
            const version = parseFloat(RegExp.$1);
            if (version > 2.3) {
                const phoneScale = window.screen.width / 750;
                document.write('<meta name="viewport" content="width=750, minimum-scale = ' + phoneScale + ', maximum-scale = ' + phoneScale + ', target-densitydpi=device-dpi">');
            } else {
                document.write('<meta name="viewport" content="width=, target-densitydpi=device-dpi">');
            }
        } else {
            document.write('<meta name="viewport" content="width=750, user-scalable=no">');
        }
    </script>
    <script src="js/jquery-3.4.1.min.js" type="text/javascript"></script>
</head>

<body>
<div id="productList">
    <div id="head">
        <div class="search_box" onclick="jumpToSearchPage();" style="width: 538px;margin-right:25px;">
            <div class="search_ico"></div>
            <input class="search_input" placeholder="搜索需要的商品" readonly style="width:400px" type="text">
        </div>
        <div class="screenbt" onclick="showScreenBox();" style="margin-right:25px;"></div>
        <a class="ico" href="myAuction.html"></a>
    </div>
    <div id="top_nav">
        <ul>
            <li class="hover" data-by="composite_index" data-mode="DESC" onclick="changeOrderBy(this);">
                <span>综合</span>
            </li>
            <li data-by="bidding_number" data-mode="DESC" onclick="changeOrderBy(this);">
                <p>出价次数</p>
            </li>
            <li data-by="current_price" data-mode="DESC" onclick="changeOrderBy(this);">
                <p>当前价格</p>
            </li>
            <li data-by="end_timestamp" data-mode="DESC" onclick="changeOrderBy(this);">
                <p>剩余时间</p>
            </li>
        </ul>
        <div class="switcher" onclick="switchingLayout();"></div>
    </div>

    <div id="content" style="margin: 0;">
        <div class="mescroll" id="mescroll">
            <ul id="dataList">
                <!--<li>
                    <img src="img/productList/img.jpg" alt="" class="img_big"/>
                    <div class="detail">
                        <p class="name">正品手办正品手办...</p>
                        <div class="message">
                            <p class="number">已出价<span>1222</span>次</p>
                            <p><span>89</span>% 好评</p>
                        </div>
                        <div class="price">
                            <p class="price1">￥<span>9999</span></p>
                            <p class="price2">一口价￥<span>1999</span></p>
                        </div>
                        <p class="time">剩余时间<span class="data">6</span>天<span class="hour">22</span>小时</p>
                        <div class="lable">
                            <p>#海贼王</p>
                            <p>#海贼王</p>
                        </div>
                        <div class="zan">
                            <img class="img" src="img/productList/Recommend_normal@2x.png">
                            <img class="img" src="img/productList/Recommend_Selection@2x.png">
                        </div>
                    </div>
                </li>-->
            </ul>
        </div>
    </div>

    <!--筛选条件弹窗-->
    <div id="screen_box">
        <div class="click" onclick="hideScreenBox();"></div>
        <div class="screen">
            <div class="condition">
                <p>关键字</p>
                <div class="input">
                    <input id="keyword" maxlength="15" type="text">
                </div>
            </div>
            <div class="condition">
                <p>当前价格</p>
                <div class="input">
                    <input id="price_1" maxlength="20" onkeyup="this.value=this.value.replace(/[^\d]/g,'')"
                           style="width:170px;float:left"
                           type="tel">
                    ~
                    <input id="price_2" maxlength="20" min="$('#price_1').val()"
                           onkeyup="this.value=this.value.replace(/[^\d]/g,'')"
                           style="width:170px;float:right" type="tel">
                </div>
            </div>
            <div class="condition">
                <p>一口价</p>
                <div class="input">
                    <input id="price_3" maxlength="20" onkeyup="this.value=this.value.replace(/[^\d]/g,'')"
                           style="width:170px;float:left"
                           type="tel">
                    ~
                    <input id="price_4" maxlength="20" min="$('#price_3').val()"
                           onkeyup="this.value=this.value.replace(/[^\d]/g,'')"
                           style="width:170px;float:right" type="tel">
                </div>
            </div>
            <div class="condition">
                <p>拍品ID</p>
                <div class="input">
                    <input id="productId" maxlength="20" type="text">
                </div>
            </div>
            <div class="condition">
                <p>卖家昵称</p>
                <div class="input">
                    <input id="sellerName" maxlength="25" type="text">
                </div>
            </div>

            <div class="bt_box">
                <button onclick="resetScreenCondition();">重置</button>
                <button onclick="saveScreenCondition();">保存条件</button>
                <button class="seachbt" onclick="searchByScreenCondition();">搜索</button>
            </div>
            <div class="record_box">
                <div class="title">
                    <p class="state">保存记录</p>
                    <p class="deletebt" onclick="deleteCond()">
                        <img alt="" src="img/index/delete.png">
                        <span>清空</span>
                    </p>
                </div>
                <ul id="record_list">

                </ul>
            </div>
        </div>
    </div>

    <div class="hint_box">
        <p></p>
    </div>

</div>

<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
<script src="mescroll/mescroll.min.js" type="text/javascript"></script>
<script src="js/common.js" type="text/javascript"></script>
<script type="text/javascript">
    shareMsg(); //分享


    // 设置内容区域高度
    $("#content").height($(window).height());


    let cateId = getQueryStringByName('cateId');
    if (Istrue(cateId)) {
        visiAddRecord(cateId)//访问统计
    }

    let data_title = getQueryStringByName('data');
    if (Istrue(data_title)) {
        console.log(data_title);
        $('title').text(decodeURI(decodeURI(data_title)))
    } else {
        $('title').text('拍品')
    }

    /* switch(data){
        case 1:
            $('title').text()
            break;
    }
     */


    /**
     * 跳转到搜索页面
     */
    function jumpToSearchPage() {
        location.href = 'search.html';
    }

    /**
     * 显示筛选条件弹窗
     */
    function showScreenBox() {
        $("#screen_box").fadeIn(200);
    }

    /**
     * 隐藏筛选条件弹窗
     */
    function hideScreenBox() {
        $("#screen_box").fadeOut(200);
    }

    // 获取筛选记录
    $.ajax({
        url: link + '/goods/screenRecords',
        type: 'GET',
        data: {
            requestId: md5(new Date().getTime()),
            timestamp: new Date().getTime()
        }
    }).done(function (response) {
        console.log(response);

        handler({
            res: response,
            fun1: function () {
                screenRecords = response.data;
                // 设置筛选记录列表
                setScreenRecordList();
            }
        })
    });

    /**
     * 设置筛选记录列表
     */
    function setScreenRecordList() {
        let result = '';
        for (let i = 0; i < screenRecords.length; i++) {
            result += '<li onclick="setScreenCondition(' + i + ');">';
            if (screenRecords[i].keyword) {
                result += '关键字:' + screenRecords[i].keyword + ';'
            }
            if (screenRecords[i].currentPriceMin) {
                result += '当前价格:' + screenRecords[i].currentPriceMin + ';'
            }
            if (screenRecords[i].currentPriceMax) {
                result += '当前最高价:' + screenRecords[i].currentPriceMax + ';'
            }
            if (screenRecords[i].buyoutPriceMin) {
                result += '一口价最低价:' + screenRecords[i].buyoutPriceMin + ';'
            }
            if (screenRecords[i].buyoutPriceMax) {
                result += '一口价最高价:' + screenRecords[i].buyoutPriceMax + ';'
            }
            if (screenRecords[i].auctionId) {
                result += '拍品ID:' + screenRecords[i].auctionId + ';'
            }
            if (screenRecords[i].sellerName) {
                result += '卖家昵称:' + screenRecords[i].sellerName + ';'
            }
            result += '</li>';
        }
        $('#record_list').html(result);
    }

    /**
     *设置筛选条件
     * @param index 下标
     */
    function setScreenCondition(index) {
        $("#keyword").val(screenRecords[index].keyword || '');
        $("#price_1").val(screenRecords[index].currentPriceMin || '');
        $("#price_2").val(screenRecords[index].currentPriceMax || '');
        $("#price_3").val(screenRecords[index].buyoutPriceMin || '');
        $("#price_4").val(screenRecords[index].buyoutPriceMax || '');
        $("#productId").val(screenRecords[index].auctionId || '');
        $("#sellerName").val(screenRecords[index].sellerName || '');
    }

    /**
     *重置筛选条件
     */
    function resetScreenCondition() {
        $('.condition input').val('');
    }

    /**
     * 保存筛选条件
     */
    function saveScreenCondition() {
        // 获取筛选条件
        let reqData = getScreenCondition();
        if (reqData == null) return;

        reqData.requestId = md5(JSON.stringify(reqData));
        reqData.timestamp = new Date().getTime();

        $.ajax({
            url: link + '/goods/screenRecords',
            type: 'POST',
            data: reqData
        }).done(function (response) {
            console.log(response);

            handler({
                res: response,
                fun1: function () {
                    screenRecords.unshift(response.data);
                    // 设置筛选记录列表
                    setScreenRecordList();
                    // 重置筛选条件
                    resetScreenCondition();
                }
            })
        });
    }

    /**
     *获取筛选条件
     */
    function getScreenCondition() {
        let condition = {
            keyword: $('#keyword').val(),
            currentPriceMin: $('#price_1').val(),
            currentPriceMax: $('#price_2').val(),
            buyoutPriceMin: $('#price_3').val(),
            buyoutPriceMax: $('#price_4').val(),
            auctionId: $('#productId').val(),
            sellerName: $('#sellerName').val()
        };
        if (parseInt(condition.currentPriceMax) < parseInt(condition.currentPriceMin)) {
            hint('请输入正确的价格区间');
            return null;
        }
        if (parseInt(condition.buyoutPriceMax) < parseInt(condition.buyoutPriceMin)) {
            hint('请输入正确的价格区间');
            return null;
        }
        return condition;
    }

    /**
     * 按筛选条件搜索
     */
    function searchByScreenCondition() {
        // 获取筛选条件
        let reqData = getScreenCondition();
        if (reqData == null) return;

        // 循环把筛选条件加入请求参数中
        for (let name in reqData) {
            // noinspection JSUnfilteredForInLoop
            paramObject[name] = reqData[name];
        }

        // 隐藏筛选条件弹窗
        hideScreenBox();

        // 更改排序字段
        changeOrderBy($('#top_nav li:nth-child(1)'));
    }

    /**
     * 更改排序字段
     */
    function changeOrderBy(that) {
        // 设置排序字段和排序方式
        paramObject.orderBy = $(that).data('by');
        paramObject.orderMode = $(that).data('mode');

        // 设置选中排序
        $("#top_nav li").removeClass("hover");
        $(that).addClass("hover");

        // 重置列表数据
        mescroll.resetUpScroll();

        if ('composite_index' === paramObject.orderBy) {
            return;
        }
        if ('DESC' === paramObject.orderMode) {
            $(that).data('mode', 'ASC');
        } else {
            $(that).data('mode', 'DESC');
        }
    }

    /**
     * 切换布局
     */
    function switchingLayout() {
        $(".switcher").toggleClass("hover");
        $("#dataList").toggleClass("hover");
    }

    // 参数对象
    const paramObject = getParamObject();
    // 设置排序字段和排序方式
    paramObject.orderBy = 'composite_index';
    paramObject.orderMode = 'DESC';
    // 创建mescroll对象
    const mescroll = new MeScroll('mescroll', {
        up: {
            callback: upCallback, // 上拉回调,此处可简写; 相当于 callback: function (page) { getListData(page); }
            isBounce: false, // 此处禁止ios回弹,解析(务必认真阅读,特别是最后一点): http://www.mescroll.com/qa.html#q10
            offset: 100,
            clearEmptyId: 'dataList', //1.下拉刷新时会自动先清空此列表,再加入数据; 2.无任何数据时会在此列表自动提示空
            toTop: { // 配置回到顶部按钮
                src: '../res/img/mescroll-totop.png' // 默认滚动到1000px显示,可配置offset修改
            }
        }
    });

    /**
     * 上拉加载的回调
     * @param page 分页参数{num:1, size:10}; num:当前页 默认从1开始, size:每页数据条数,默认10
     */
    function upCallback(page) {
        paramObject.pageNumber = page.num; // 页码, 默认从1开始
        paramObject.pageSize = page.size; // 页长, 默认每页10条
        paramObject.requestId = md5(JSON.stringify(paramObject)); // 请求ID
        paramObject.timestamp = new Date().getTime(); // 请求时间戳

        $.ajax({
            url: link + '/goods/auctions',
            data: paramObject
        }).done(function (response) {
            console.log(response);

            handler({
                res: response,
                fun1: function () {
                    const curPageData = response.data; // 接口返回的当前页数据列表
                    const totalSize = response.count; // 接口返回的总数据量(比如列表有26个数据,每页10条,共3页; 则totalSize值为26)
                    mescroll.endBySize(curPageData.length, totalSize); // 联网成功的回调,隐藏下拉刷新和上拉加载的状态;

                    setListData(curPageData); // 设置列表数据
                }
            })
        });
    }

    /**
     * 设置列表数据
     * @param curPageData
     */
    function setListData(curPageData) {
        let listData = '';
        for (let i = 0; i < curPageData.length; i++) {
            let curData = curPageData[i];
            // 计算剩余时间
            residueTime(curData['endTimestamp']);
            // 图片链接
            let imageURL = '';

            if (curData.images) {
                imageURL = curData.images.split(';')[0];
            }
            // 好评率
            let praiseRate = curData['praiseRate'] > 0 ? curData['praiseRate'] : '-';
            // 一口价
            let buyoutPrice = curData.buyoutPrice ? '<p class="price2">一口价 ￥<span>' + curData.buyoutPrice + '</span></p>' : '';

            listData += '<li>';
            listData += '    <div class="img_box">';
            listData += '    	<div class="img_big" onclick="productDetail(\'' + curData.auctionId + '\')">' + compressPicture("0", imageURL) + '    </div>';
            listData += '    	<div class="recommend_box">';
            listData += '        	<div class="zan" onclick="plantGrass(this, \'' + curData.auctionId + '\');">';
            listData += '            	<img class="img" src="img/productList/recommend_' + curData['plantGrass'] + '.png" alt="">';
            listData += '        	</div>';
            listData += '        </div>';
            listData += '    </div>';
            listData += '    <div class="detail">';
            listData += '        <p class="name">' + curData.title + '</p>';
            listData += '        <p class="time">剩余时间 <span class="data">' + day + '</span>天<span class="hour">' + hour + '</span>小时</p>';
            listData += '        <div class="price">';
            listData += '            <p class="price1"> ￥<span>' + curData['currentPrice'] + '</span></p>';
            listData += '            ' + buyoutPrice;
            listData += '        </div>';
            listData += '        <div class="message">';
            listData += '            <p class="number">已出价 <span>' + curData['biddingNumber'] + '</span>次</p>';
            listData += '            <p><span>' + praiseRate + '</span>%&nbsp;好评</p>';
            listData += '        </div>';


            listData += '    </div>';
            listData += '</li>';
        }
        $('#dataList').append(listData);
    }

    /**
     * 种草
     * @param that
     * @param auctionId 拍品ID
     */
    function plantGrass(that, auctionId) {
        $.ajax({
            url: link + '/goods/collects',
            type: 'POST',
            data: {
                auctionId: auctionId
            }
        }).done(function (response) {
            console.log(response);

            handler({
                res: response,
                fun1: function () {
                    $(that).html('<img class="img" src="img/productList/recommend_' + response.data + '.png" alt="">');
                }
            });
        });
    }
</script>
</body>

</html>
