<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="true" name="HandheldFriendly">
    <meta content="yes" name="apple-touch-fullscreen">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="width=device-width,target-densitydpi=device-dpi, user-scalable=0" name="viewport">
    <title>我的订单</title>
    <link href="css/style.css" rel="stylesheet">
    <link href="mescroll/mescroll.min.css" rel="stylesheet">
    <style type="text/css">
        .mescroll {
            position: fixed;
            top: 224px;
            bottom: 0;
            height: auto;
        }

        .data-list li {
            position: relative;
            padding: 10px 8px 10px 120px;
            border-bottom: 1px solid #eee;
        }
    </style>

    <script type="text/javascript">
        if (/Android (\d+\.\d+)/.test(navigator.userAgent)) {
            let version = parseFloat(RegExp.$1);
            if (version > 2.3) {
                let phoneScale = window.screen.width / 750;
                document.write('<meta name="viewport" content="width=750, minimum-scale = ' + phoneScale + ', maximum-scale = ' + phoneScale + ', target-densitydpi=device-dpi">');
            } else {
                document.write('<meta name="viewport" content="width=, target-densitydpi=device-dpi">');
            }
        } else {
            document.write('<meta name="viewport" content="width=750, user-scalable=no">');
        }
    </script>
    <script src="js/jquery-3.4.1.min.js" type="text/javascript"></script>
</head>
<body>
<div id="myAuction">

    <div id="content">
        <div class="head_box">

            <ul class="head_menu">
                <li>我是买家</li>
                <li>我是卖家</li>
            </ul>

            <ol class="submenu submenu1">
                <li data-type="PLANT_GRASS" style="margin-left: 56px;">种草</li>
                <li data-type="JOIN_AUCTION">参拍</li>
                <li data-type="WIN_THE_BID"><p>中标</p></li>
                <li data-type="END">结束</li>
            </ol>

            <ol class="submenu submenu2">
                <li data-type="IN_PROGRESS" style="margin-left: 56px;">进行中</li>
                <li data-type="DEAL"><p>成交</p></li>
                <li data-type="NOT_DEAL">未成交</li>
                <li data-type="NOT_START">未开始</li>
            </ol>

        </div>

        <div class="container">

            <div class="mescroll" id="mescroll">
                <ul class="part" id="dataList">

                </ul>
            </div>

            <div class="pull_menu">
                <div class="click" onclick="$('.pull_menu').fadeOut(200);"></div>
                <div class="menu_box">
                    <ul>
                        <li data-status="ALL">全部</li>
                        <li data-status="PENDING_PAYMENT">待付款</li>
                        <li data-status="PENDING_DELIVERY">待发货</li>
                        <li data-status="PENDING_RECEIPT">待收货</li>
                        <li data-status="PENDING_EVALUATE">待评价</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js" type="text/javascript"></script>
<script src="mescroll/mescroll.min.js" type="text/javascript"></script>
<script src="js/common.js" type="text/javascript"></script>
<script type="text/javascript">
    let type = getQueryStringByName('type') || 'PLANT_GRASS';
    let status = getQueryStringByName('status') || 'ALL';

    if ('PLANT_GRASS' === type) {
        $('.submenu2').hide();
        $('.head_menu li:first-child').addClass('hover');
        $('.submenu1 li:nth-child(1)').addClass('hover');
    } else if ('JOIN_AUCTION' === type) {
        $('.submenu2').hide();
        $('.head_menu li:first-child').addClass('hover');
        $('.submenu1 li:nth-child(2)').addClass('hover');
    } else if ('WIN_THE_BID' === type) {
        $('.submenu2').hide();
        $('.head_menu li:first-child').addClass('hover');
        $('.submenu1 li:nth-child(3)').addClass('hover');
    } else if ('END' === type) {
        $('.submenu2').hide();
        $('.head_menu li:first-child').addClass('hover');
        $('.submenu1 li:nth-child(4)').addClass('hover');
    } else if ('IN_PROGRESS' === type) {
        $('.submenu1').hide();
        $('.head_menu li:last-child').addClass('hover');
        $('.submenu2 li:nth-child(1)').addClass('hover');
    } else if ('DEAL' === type) {
        $('.submenu1').hide();
        $('.head_menu li:last-child').addClass('hover');
        $('.submenu2 li:nth-child(2)').addClass('hover');
    } else if ('NOT_DEAL' === type) {
        $('.submenu1').hide();
        $('.head_menu li:last-child').addClass('hover');
        $('.submenu2 li:nth-child(3)').addClass('hover');
    } else if ('NOT_START' === type) {
        $('.submenu1').hide();
        $('.head_menu li:last-child').addClass('hover');
        $('.submenu2 li:nth-child(4)').addClass('hover');
    }
    if ('ALL' === status) {
        $('.menu_box li:nth-child(1)').addClass('hover');
    } else if ('PENDING_PAYMENT' === status) {
        $('.menu_box li:nth-child(2)').addClass('hover');
    } else if ('PENDING_DELIVERY' === status) {
        $('.menu_box li:nth-child(3)').addClass('hover');
    } else if ('PENDING_RECEIPT' === status) {
        $('.menu_box li:nth-child(4)').addClass('hover');
    } else if ('PENDING_EVALUATE' === status) {
        $('.menu_box li:nth-child(5)').addClass('hover');
    }

    /**
     * 内容区域高度设置
     */
    $("#content").height($(window).height());

    /**
     * 用户类型切换
     */
    $('.head_menu').on('click', 'li', function () {
    <<<<<<< .
        mine;
        $('.pull_menu').fadeOut(200);

    ||||||| .
        r995
        === === =
            $('.pull_menu').fadeOut(200);

    >>>>>>> .
        r1018;
        $('.head_menu li').removeClass('hover');
        $(this).addClass('hover');

        // 买家
        if (0 === $(this).index()) {
            type = $('.submenu1 li.hover').data('type');
            if (undefined === type) {
                type = 'PLANT_GRASS';
                $('.submenu1 li:nth-child(1)').addClass('hover');
            }

            $('.submenu1').show();
            $('.submenu2').hide();
        }
        // 卖家
        else {
            type = $('.submenu2 li.hover').data('type');
            if (undefined === type) {
                type = 'IN_PROGRESS';
                $('.submenu2 li:nth-child(1)').addClass('hover');
            }

            $('.submenu1').hide();
            $('.submenu2').show();
        }

        history.replaceState({}, '', '?type=' + type + '&status=' + status);
        // 重置列表数据
        mescroll.resetUpScroll();
    });

    /**
     * 买家拍品类型切换
     */
    $('.submenu1').on('click', 'li', function () {
    <<<<<<< .
        mine;
        if (2 === $('.submenu1 li.hover').index() && 2 === $(this).index()) {
        ||||||| .
            r995;
            if (2 === $('.submenu1 li.hover').index()) {
            ======
                =;
                if (2 === $('.submenu1 li.hover').index() && 2 === $(this).index()) {
                >>>>>>> .
                    r1018;
                    return $('.pull_menu').fadeIn(200);
                }
            <<<<<<< .
                mine;
                $('.pull_menu').fadeOut(200);
            ||||||| .
                r995
                === === =
                    $('.pull_menu').fadeOut(200);
            >>>>>>> .
                r1018;

                $('.submenu1 li').removeClass('hover');
                $(this).addClass('hover');

                type = $(this).data('type');
                history.replaceState({}, '', '?type=' + type + '&status=' + status);
                // 重置列表数据
                mescroll.resetUpScroll();
            }
        );

    /**
     * 卖家拍品类型切换
     */
    $('.submenu2').on('click', 'li', function () {
    <<<<<<< .
        mine;
        if (1 === $('.submenu2 li.hover').index() && 1 === $(this).index()) {
        ||||||| .
            r995;
            if (1 === $('.submenu2 li.hover').index()) {
            ======
                =;
                if (1 === $('.submenu2 li.hover').index() && 1 === $(this).index()) {
                >>>>>>> .
                    r1018;
                    return $('.pull_menu').fadeIn(200);
                }
            <<<<<<< .
                mine;
                $('.pull_menu').fadeOut(200);
            ||||||| .
                r995
                === === =
                    $('.pull_menu').fadeOut(200);
            >>>>>>> .
                r1018;

                $('.submenu2 li').removeClass('hover');
                $(this).addClass('hover');

                type = $(this).data('type');
                history.replaceState({}, '', '?type=' + type + '&status=' + status);
                // 重置列表数据
                mescroll.resetUpScroll();
            }
        );

    /**
     * 订单状态切换
     */
    $('.menu_box').on('click', 'li', function () {
        $('.menu_box li').removeClass('hover');
        $(this).addClass('hover');

        status = $(this).data('status');
        history.replaceState({}, '', '?type=' + type + '&status=' + status);
        // 重置列表数据
        mescroll.resetUpScroll();

        $('.pull_menu').fadeOut(200);
    });

    let mescroll = new MeScroll('mescroll', {
        up: {
            callback: upCallback, //上拉回调,此处可简写; 相当于 callback: function (page) { getListData(page); }
            isBounce: false, //此处禁止ios回弹,解析(务必认真阅读,特别是最后一点): http://www.mescroll.com/qa.html#q10
            offset: 100,
            clearEmptyId: "dataList", //1.下拉刷新时会自动先清空此列表,再加入数据; 2.无任何数据时会在此列表自动提示空
            toTop: { //配置回到顶部按钮
                src: "../res/img/mescroll-totop.png" //默认滚动到1000px显示,可配置offset修改
            }
        }
    });

    function upCallback(page) {
        let ajaxData = {
            pageNumber: page.num,
            pageSize: page.size,
            type: type,
            status: status
        };
        ajaxData.requestId = md5(JSON.stringify(ajaxData)); // 请求ID
        ajaxData.timestamp = new Date().getTime(); // 请求时间戳
        $.ajax({
            url: link + '/goods/auctions/mine',
            type: 'GET',
            data: ajaxData
        }).done(function (response) {
            console.log(response);

            handler({
                res: response,
                fun1: function () {
                    let curPageData = response.data; // 接口返回的当前页数据列表
                    let totalSize = response.count; // 接口返回的总数据量(比如列表有26个数据,每页10条,共3页; 则totalSize值为26)
                    mescroll.endBySize(curPageData.length, totalSize); // 联网成功的回调,隐藏下拉刷新和上拉加载的状态;

                    setListData(curPageData); // 设置列表数据
                }
            })
        })
    }

    let STATUS_INFO = {
        'PENDING_PAYMENT': '待付款',
        'PENDING_DELIVERY': '待发货',
        'PENDING_RECEIPT': '待收货',
        'PENDING_EVALUATE': '待评价',
        'TRADE_COMPLETED': '交易完成'
    };

    // 买家按钮 HTML
    let BUYER_BUTTON_HTML = {
        'PENDING_PAYMENT': '<button class="color order_detail" data-oid="OID">支付</button>' +
            '<button class="contact_seller" data-sid="SID" data-sname="SNAME">联系卖家</button>',
        'PENDING_DELIVERY': '<button class="contact_seller" data-sid="SID" data-sname="SNAME">联系卖家</button>',
        'PENDING_RECEIPT': '<button class="color order_detail" data-oid="OID">确认收货</button>' +
            '<button class="contact_seller" data-sid="SID" data-sname="SNAME">联系卖家</button>' +
            '<button class="logistics_info" data-oid="OID">物流信息</button>',
        'PENDING_EVALUATE': '<button class="contact_seller" data-sid="SID" data-sname="SNAME">联系卖家</button>' +
            '<button class="evaluate_seller" data-oid="OID">评价</button>',
        'TRADE_COMPLETED': '<button class="contact_seller" data-sid="SID" data-sname="SNAME">联系卖家</button>' +
            '<button class="delete_record" data-aid="AID">删除记录</button>'
    };

    // 卖家按钮 HTML
    let SELLER_BUTTON_HTML = {
        'PENDING_PAYMENT': '<button class="contact_buyer" data-bid="BID" data-bname="BNAME">联系买家</button>' +
            '<button class="color order_detail" data-oid="OID">查看</button>',
        'PENDING_DELIVERY': '<button class="color order_detail"  data-oid="OID">发货</button>' +
            '<button class="contact_buyer" data-bid="BID" data-bname="BNAME">联系买家</button>',
        'PENDING_RECEIPT': '<button class="logistics_info" data-oid="OID">物流信息</button>',
        'PENDING_EVALUATE': '<button class="evaluate_buyer" data-oid="OID">评价</button>',
        'TRADE_COMPLETED': '<button class="delete_record" data-aid="AID">删除记录</button></div>'
    };

    /**
     * 设置列表数据
     * @param curPageData 当前分页数据
     */
    function setListData(curPageData) {
        let dataListHTML = '';
        console.log(curPageData);
        for (let i = 0; i < curPageData.length; i++) {
            let curData = curPageData[i];
            let imageURL = "";
            // 图片 URL
            if (curData.images) {
                imageURL = curData.images.split(';')[0];
            }
            console.log(imageURL);
            // 详情 HTML
            let detailHTML = '';
            // 按钮 HTML
            let buttonHTML = '';

            if ('PLANT_GRASS' === type || 'JOIN_AUCTION' === type || 'END' === type) {
                // 计算剩余时间
                residueTime(curData['endTimestamp']);
                // 一口价HTML
                let buyoutPriceHTML = curData.buyoutPrice ? '<p class="price2">一口价￥<span>' + curData.buyoutPrice + '</span></p>' : '';

                detailHTML += '<div class="message">';
                detailHTML += '    <p class="number">已出价<span>' + curData['biddingNumber'] + '</span>次</p>';
                detailHTML += '    <p><span>' + curData['praiseRate'] + '</span>% 好评</p>';
                detailHTML += '</div>';
                detailHTML += '<div class="price">';
                detailHTML += '    <p class="price1">￥<span>' + curData['currentPrice'] + '</span></p>' + buyoutPriceHTML;
                detailHTML += '</div>';
                detailHTML += '<p class="time">剩余时间<span class="data">' + day + '</span>天<span class="hour">' + hour + '</span>小时</p>';
                /* detailHTML += '<div class="lable">';
                detailHTML += '    <p>#海贼王</p>';
                detailHTML += '    <p>#海贼王</p>';
                detailHTML += '</div>'; */

                buttonHTML = '<button class="color auction_detail" data-aid="' + curData.auctionId + '">出价</button>';
                if ('END' === type) {
                    buttonHTML = '<button class="delete_record" data-aid="' + curData.auctionId + '">删除记录</button>';
                }
            }
            if ('WIN_THE_BID' === type) {
                detailHTML += '<div class="seller">';
                detailHTML += '    <div class="head_img">' + headImgHtml(curData.avatarPath) + '</div>';
                detailHTML += '    <p class="name">' + curData.sellerName + '</p>';
                detailHTML += '</div>';
                detailHTML += '<div class="price">';
                detailHTML += '    <p class="price1">￥<span>' + curData['dealPrice'] + '</span></p>';
                detailHTML += '    <p class="state">' + STATUS_INFO[curData['orderStatus']] + '</p>';
                detailHTML += '</div>';

                buttonHTML = BUYER_BUTTON_HTML[curData['orderStatus']]
                    .replace('OID', curData['orderId'])// 订单ID
                    .replace('AID', curData['auctionId'])// 拍品ID
                    .replace('SID', curData['sellerId'])// 卖家ID
                    .replace('SNAME', curData['sellerName']);// 卖家名称
            }
            if ('IN_PROGRESS' === type) {
                detailHTML += '        <p class="bieginprice">￥<span>' + curData['currentPrice'] + '</span></p>';
                detailHTML += '        <p class="state2">进行中</p>';

                buttonHTML = '<button class="color auction_detail" data-aid="' + curData.auctionId + '">查看</button>';
            }
            if ('DEAL' === type) {
                detailHTML += '        <p class="bieginprice">￥<span>' + curData['dealPrice'] + '</span></p>';
                detailHTML += '        <p class="state2">' + STATUS_INFO[curData['orderStatus']] + '</p>';

                buttonHTML = SELLER_BUTTON_HTML[curData['orderStatus']]
                    .replace('OID', curData['orderId'])// 订单ID
                    .replace('AID', curData['auctionId'])// 拍品ID
                    .replace('BID', curData['buyerId'])// 买家ID
                    .replace('BNAME', curData['buyerName']);// 买家名称
            }
            if ('NOT_DEAL' === type) {
                detailHTML += '        <p class="bieginprice">￥<span>' + curData['currentPrice'] + '</span></p>';
                detailHTML += '        <p class="state2">未成交</p>';

                buttonHTML = '<button class="color" onclick="again(\'' + curData.auctionId + '\')">再次发布</button>' +
                    '<button class="delete_record" data-aid="' + curData.auctionId + '">删除记录</button>';
            }
            if ('NOT_START' === type) {
                detailHTML += '        <p class="bieginprice">￥<span>' + curData['currentPrice'] + '</span></p>';
                detailHTML += '        <p class="state2">未开始</p>';

                buttonHTML = '<button class="color auction_detail" data-aid="' + curData.auctionId + '">查看</button>';
            }

            dataListHTML += '<li>';
            dataListHTML += '    <div class="productMsg">';
            dataListHTML += '    <div  class="img_big">' + compressPicture(0, imageURL) + '</div>';
            dataListHTML += '        <div class="detail">';
            dataListHTML += '        <p class="title">' + curData.title + '</p>' + detailHTML;
            dataListHTML += '        </div>';
            dataListHTML += '    </div>';
            dataListHTML += '    <div class="bt_box bt1">' + buttonHTML + '</div>';
            dataListHTML += '</li>';
        }
        $('#dataList').append(dataListHTML);
    }

    /**
     * 拍品详情
     */
    $('#dataList').on('click', '.auction_detail', function () {
        location.href = 'productDetail.html?productId=' + $(this).data('aid');
    });

    /**
     * 订单详情
     */
    $('#dataList').on('click', '.order_detail', function () {
        location.href = 'buyer_noPayment.html?orderId=' + $(this).data('oid');
    });

    /**
     * 联系买家
     */
    $('#dataList').on('click', '.contact_buyer', function () {
        localStorage.setItem('rong_target_name', $(this).data('bname'));
        location.href = 'messageChat.html?targetId=' + $(this).data('bid') + '&targetType=1';
    });

    /**
     * 联系卖家
     */
    $('#dataList').on('click', '.contact_seller', function () {
        localStorage.setItem('rong_target_name', $(this).data('sname'));
        location.href = 'messageChat.html?targetId=' + $(this).data('sid') + '&targetType=1';
    });

    /**
     * 物流信息
     */
    $('#dataList').on('click', '.logistics_info', function () {
        location.href = 'logisticsDetails.html?orderId=' + $(this).data('oid');
    });

    /**
     * 评价买家
     */
    $('#dataList').on('click', '.evaluate_buyer', function () {
        location.href = 'evaluate_buyer.html?orderId=' + $(this).data('oid');
    });

    /**
     * 评价卖家
     */
    $('#dataList').on('click', '.evaluate_seller', function () {
        location.href = 'evaluate_buyer.html?orderId=' + $(this).data('oid');
    });

    /**
     * 删除记录
     */
    $('#dataList').on('click', '.delete_record', function () {
        let auctionId = $(this).data('aid');
        let currentData = $(this).parents('li');

        $.ajax({
            url: link + '/goods/auctions/' + auctionId,
            type: 'DELETE',
            data: {
                requestId: md5(auctionId + type),
                timestamp: new Date().getTime(),
                auctionType: type
            },
            dataType: "Json",
            success: function (res) {
                console.log(res)

            },
            error: function (e) {
            }
        }).done(function (response) {
            console.log(response);

            handler({
                res: response,
                fun1: function () {
                    $(currentData).remove();
                }
            })
        });
    });
</script>
</body>
</html>