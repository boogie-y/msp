<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>修改资料</title>
    <meta content="width=device-width,target-densitydpi=device-dpi, user-scalable=0" name="viewport"/>
    <meta content="yes" name="apple-mobile-web-app-capable"/>
    <meta content="true" name="HandheldFriendly"/>
    <meta content="yes" name="apple-touch-fullscreen"/>
    <script type="text/javascript">
        if (/Android (\d+\.\d+)/.test(navigator.userAgent)) {
            var version = parseFloat(RegExp.$1);
            if (version > 2.3) {
                var phoneScale = parseInt(window.screen.width) / 750;
                document.write('<meta name="viewport" content="width=750, minimum-scale = ' + phoneScale + ', maximum-scale = ' + phoneScale + ', target-densitydpi=device-dpi">');
            } else {
                document.write('<meta name="viewport" content="width=, target-densitydpi=device-dpi">');
            }
        } else {
            document.write('<meta name="viewport" content="width=750, user-scalable=no">');
        }
    </script>
    <link href="css/style.css" rel="stylesheet">
    <script src="js/jquery-3.4.1.min.js" type="text/javascript"></script>
    <!-- <link href="city/city.css" rel="stylesheet"> -->


</head>
<body>
<div id="modified">


    <div class="content">
        <div class="head_box">
            <div class="head_img" style="position: relative;">


                <!--上传头像DEMO-->
                <input accept="image/*" id="doc" name="file" onchange="setImagePreview();"
                       style="width:100%;height:100%;opacity:0;position: absolute;left:0;top:0;z-index: 1;" type="file">
                <div id="result" style="position: absolute;left:0;top:0;width:100%;height:100%"><img
                        src="img/myhome/head_img.png" style="width: 100%;display:block;height: 100%;"></div>

            </div>
            <p class="text">点击上传头像</p>
        </div>
        <div class="mesg_box">
            <div class="box">
                <p class="title">昵称</p>
                <input class="realname" maxlength="20" placeholder="请输入您的用户名" type="text"/>
            </div>

            <div class="box">
                <p class="title">性别</p>
                <div class="select_box">
                    <p class="male hover" date-id="0">男</p>
                    <p class="women" date-id="1">女</p>
                </div>
            </div>

            <div class="box">
                <p class="title">城市</p>
                <div class="right">
                    <input class="input addr" id="address" maxlength="10" placeholder="请填写您的城市" type="text">
                </div>
                <!-- <input maxlength="10" class="addr" type="text" placeholder=""/> -->
            </div>

            <div class="box">
                <p class="title">身份</p>
                <p class="selectID"></p>
                <!--<input class="realname" type="text" placeholder="请输入您的昵称"/>-->
            </div>

            <p class="title">签名</p>
            <div class="box">

                <textarea class="mark_detail" cols="" maxlength="20" name="" placeholder="来写个签名，让别人更好的了解你吧！"
                          rows=""></textarea>
            </div>
            <button class="savebt" onclick="saveMsg()">保存</button>

        </div>
    </div>


    <div class="id_box">
        <div class="head">
            <p class="title">身份选择</p>
            <p class="close"></p>
        </div>

        <div class="container">
            <div class="box pitch">
                <p class="title">当前标签（<span>0</span>/3）</p>
                <ul class="lable">
                </ul>
            </div>

            <div class="select_box box">
                <p class="title">分类1</p>
                <ul class="lable lable0">
                </ul>
            </div>

            <div class="select_box box">
                <p class="title">分类2</p>
                <ul class="lable lable1">
                </ul>
            </div>

            <div class="select_box box">
                <p class="title">分类3（需认证）</p>
                <ul class="lable lable2">

                </ul>
            </div>
            <p class="state">*最多可添加3个身份标签</p>
        </div>
        <div class="foot_botton">
            <button class="save">确认身份</button>
        </div>

    </div>


    <div class="hint_box" style="bottom: 200px;">
        <p></p>
    </div>


</div>


<div class="container" id="container"
     style="display: none;width:100%;height: 100%;position: fixed;top:0;left: 0;z-index: 1000;background: white;">
    <div class="row" style="position: relative;">
        <div class="col col-6" id="localImag">
            <img alt="Picture" id="image" src="../docs/images/picture.jpg">
        </div>
        <button id="button2" type="button">取消</button>
        <button id="button" type="button">确定</button>
        <style type="text/css">
            #button2 {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                font-size: 28px;
                color: #1C2027;
                background: #FFF;
                position: absolute;
                left: 20px;
                top: 20px;
            }

            #button {
                width: 100px;
                height: 100px;
                border-radius: 50%;
                font-size: 28px;
                color: #1C2027;
                background: #FFF;
                position: absolute;
                right: 20px;
                top: 20px;
            }

        </style>
    </div>
</div>


<script src="js/common.js" type="text/javascript"></script>
<script src="https://cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.min.js"></script>
<!-- <script type="text/javascript" src="city/data.js"></script> -->
<!--上传头像js-->
<link href="upload/cropper.css" rel="stylesheet">
<script src="upload/cropper.js"></script>


<script type="text/javascript">
    $(".content").css({'min-height': $(window).height()});
    var userId = getQueryStringByName('userId');
    getOneSocial(userId);//获取用户信息
    function inhtml(pd) { //用户信息填充
        console.log(pd);
        $("#result img").attr("src", link + pd.avatarPath);
        $(".realname").val(pd.username);
        if (pd.sex == false) {
            $(".select_box p").removeClass("hover");
            $(".select_box .male").addClass("hover")
        } else {
            $(".select_box p").removeClass("hover");
            $(".select_box .women").addClass("hover")
        }
        $(".addr").val(pd.domain);
        $(".mark_detail").val(pd.signature)
    }


    getCareerList();

    //获取所有用户职业
    function getCareerList() {
        var paramObject = getParamObject();
        paramObject.timestamp = new Date().getTime(); // 请求时间戳
        paramObject.requestId = md5($.param(paramObject)); // 请求ID
        $.ajax({
            url: link + "/manager/career/getCareerList?" + $.param(paramObject),
            success: function (res) {
                console.log(res);
                handler({
                    res: res,
                    fun1: function () {
                        for (var i = 0; i < res.data.length; i++) {
                            var pd = res.data[i];
                            $(".select_box .lable" + pd.careerCertLevel).append('<li data="' + pd.careerId + '">' + pd.careerName + '</li>')
                        }
                        selectCareerLis();
                    }
                })
            },
            error: function (e) {

            }
        });
    }

    function selectCareerLis() {
        var numb = 0;
        $(".select_box li").click(function () {
            if (!$(this).hasClass("current")) {
                let index = $(".select_box .current").length;

                console.log(index);
                if (index < 3) {
                    $(".pitch .title span").text(parseInt(index) + 1);

                    numb = $(this).attr("data");
                    let result = "";
                    $(this).addClass("current");
                    var txt = $(this).text();
                    result = "<li class='li" + numb + "' data_id='" + numb + "'>" + txt + "</li>";
                    $(".pitch .lable").append(result)
                } else {
                    alert("最多可选三个身份")
                }
            } else {
                $(this).removeClass("current");
                let data = $(this).attr("data");
                $(".pitch .lable .li" + data).remove()
            }
        });
    }


    //修改用户职业
    function updateUserCareer(FirstId, SecondId, ThirdId) {
        var paramObject = getParamObject();
        paramObject.careerFirstId = FirstId; // 第一职业Id
        if (Istrue(SecondId)) {
            paramObject.careerSecondId = SecondId; // 第二职业Id
        } else {
            paramObject.careerSecondId = ' '; // 第二职业Id
        }
        if (Istrue(ThirdId)) {
            paramObject.careerThirdId = ThirdId; // 第三职业Id
        } else {
            paramObject.careerThirdId = ' '; // 第三职业Id
        }
        paramObject.timestamp = new Date().getTime(); // 请求时间戳
        paramObject.requestId = md5($.param(paramObject)); // 请求ID
        $.ajax({
            url: link + "/user/user/updateUserCareer",
            type: 'POST',
            data: paramObject,
            dataType: "Json",
            success: function (res) {
                console.log(res);
                handler({
                    res: res,
                    fun1: function () {
                        $(".id_box").hide();
                        getUserCareer(userId)
                    }
                })
            },
            error: function (e) {

            }
        });
    }

    $(".foot_botton .save").click(function () {
        let ArrId = [];
        let len = $(".pitch li").length;
        if (len > 0) {
            for (var i = 0; i < len; i++) {
                let data_id = $(".pitch li").eq(i).attr("data_id");
                ArrId.push(data_id)
            }
            updateUserCareer(ArrId[0], ArrId[1], ArrId[2])
        }
    });


    //获取用户职业标签
    getUserCareer(userId)


</script>
<script>


    $(".head .close").click(function () {
//				let result = [];
//				let txt = ""
        $(".id_box").hide();
//				for(var i = 0;i <$(".pitch li").length;i++){
//					result.push($(".pitch li").eq(i).text())
//					txt = result.join('|');
//					$(".selectID").text(txt)
//					console.log(txt)
//				}

    });

    $(".selectID").click(function () {
        $(".id_box").show();
    });

    $(".select_box p").click(function () {
        $(".select_box p").removeClass("hover");
        $(this).addClass("hover")
    });


    function setImagePreview(avalue) {
        document.getElementById("container").style.display = "inline";
        var docObj = document.getElementById("doc");
        console.log(docObj.files);
        var imgObjPreview = document.getElementById("image");
        if (docObj.files && docObj.files[0]) {
            //火狐下，直接设img属性
            imgObjPreview.style.display = 'block';
            imgObjPreview.style.maxWidth = '960px';
//					imgObjPreview.style.height = '400px';
            //imgObjPreview.src = docObj.files[0].getAsDataURL();
            // 取绝对路径的getAsDataURL

            //火狐7以上版本不能用上面的getAsDataURL()方式获取，需要一下方式
            imgObjPreview.src = window.URL.createObjectURL(docObj.files[0]);
        } else {
            //IE下，使用滤镜
            docObj.select();
            var imgSrc = document.selection.createRange().text;
            var localImagId = document.getElementById("localImag");
            //必须设置初始大小
            localImagId.style.maxWidth = "960px";
            localImagId.style.height = 'auto';
            //图片异常的捕捉，防止用户修改后缀来伪造图片
            try {
                localImagId.style.filter = "progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
                localImagId.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;
            } catch (e) {
                alert("您上传的图片格式不正确，请重新选择!");
                return false;
            }
            imgObjPreview.style.display = 'none';
            document.selection.empty();
        }
        return true;
    }

    function getRoundedCanvas(sourceCanvas) {
        var canvas = document.createElement('canvas');
        var context = canvas.getContext('2d');
        var width = sourceCanvas.width;
        var height = sourceCanvas.height;
        canvas.width = width;
        canvas.height = height;
        context.imageSmoothingEnabled = true;
        context.drawImage(sourceCanvas, 0, 0, width, height);
        context.globalCompositeOperation = 'destination-in';
        context.beginPath();
        context.arc(width / 2, height / 2, Math.min(width, height) / 2, 0, 2 * Math.PI, true);
        context.fill();
        return canvas;
    }

    var file = document.getElementById('doc');
    file.addEventListener('change', function () {
        var image = document.querySelector('#image');
        var cropper = new Cropper(image, {
            aspectRatio: 1,
            toggleDragModeOnDblclick: false,
            cropBoxResizable: false,
            cropBoxMovable: true,
            highlight: false,
            center: false,
            guides: false,
            restore: false,
            autoCropArea: 0.5,
            dragMode: 'move',
            viewMode: 1,
            // movable:false,
            ready: function () {
                var clone = this.cloneNode();
                croppable = true;
                clone.className = '';
                clone.style.cssText = (
                    'display: block;' +
                    'width: 100%;' +
                    'min-width: 100;' +
                    'min-height: 100;' +
                    'max-width: none;' +
                    'max-height: none;'
                );
            },
        });

        button.onclick = function () {
            document.getElementById("container").style.display = "none";
            var croppedCanvas;
            var roundedCanvas;
            if (!croppable) {
                return;
            }
            // Crop
            croppedCanvas = cropper.getCroppedCanvas();
            console.log(croppedCanvas);
            // Round
            roundedCanvas = getRoundedCanvas(croppedCanvas);
            // Show
            $("#result img").attr("src", roundedCanvas.toDataURL());
            $("#localImag").html('<img id="image" src="" alt="Picture">');

            sumitImageFile(roundedCanvas.toDataURL())

        }
    });
    button2.onclick = function () {
        $("#container").fadeOut(200);
        $("#localImag").html('<img id="image" src="" alt="Picture">')

    };

    //上传头像
    function sumitImageFile(base64Codes) {
        var formData = new FormData();   //这里连带form里的其他参数也一起提交了,如果不需要提交其他参数可以直接FormData无参数的构造函数
//			    formData.append("avatarFile", dataURLtoFile(base64Codes, "1.png"));
        formData.append("avatarFile", base64toFile(base64Codes));
        formData.append("timestamp", new Date().getTime());
        formData.append("requestId", 'd79b9efa995f');
        var data = formData;
        $.ajax({
            url: link + "/user/user/updateAvatar",
            data: data,
            type: "POST",
            dataType: "json",
            processData: false,//用于对data参数进行序列化处理 这里必须false
            contentType: false, //必须
            success: function (res) {
                console.log(res);
                handler({
                    res: res,
                    fun1: function () {
                        //              	window.location.href="myHome.html"
                    }
                })
            },
        })
    }


    //修改个人信息
    function saveMsg() {
        if ($(".realname").val() == "") {
            let text = "请输入用户名";
            hint(text);
            return false;
        }
        var paramObject = getParamObject();
        paramObject.username = $(".realname").val(); // 用户名
        paramObject.sex = $(".select_box .hover").attr("date-id"); // 性别
        paramObject.domain = $(".addr").val(); // 据点
        paramObject.signature = $(".mark_detail").val(); // 签名
        paramObject.timestamp = new Date().getTime(); // 请求时间戳
        paramObject.requestId = md5($.param(paramObject)); // 请求ID
        $.ajax({
            url: link + "/user/user/updateUserInfo",
            data: paramObject,
            type: "POST",
            dataType: "json",
            success: function (res) {
                console.log(res);
                handler({
                    res: res,
                    fun1: function () {
                        window.location.href = "myHome.html"
                    }
                })
            },
        })
    }

</script>
</body>
</html>