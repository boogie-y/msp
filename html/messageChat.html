<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>系统消息</title>
    <meta content="width=device-width,target-densitydpi=device-dpi, user-scalable=0" name="viewport">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="true" name="HandheldFriendly">
    <meta content="yes" name="apple-touch-fullscreen">
    <link href="css/style.css" rel="stylesheet">
    <meta content="模型APP内测招募" property="title"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="description"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="keywords"/>
    <meta content="https://www.2501p.com/img/share_logo.jpg" property="image"/>

    <meta content="模型APP内测招募" property="og:title"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="og:description"/>
    <meta content="最强最走心的模型APP登场！去模型圈大佬面对面交流，晒单拍卖无缝连接。" property="og:keywords"/>
    <meta content="https://www.2501p.com/img/share_logo.jpg" property="og:image"/>
    <script type="text/javascript">
        if (/Android (\d+\.\d+)/.test(navigator.userAgent)) {
            const version = parseFloat(RegExp.$1);
            if (version > 2.3) {
                const phoneScale = window.screen.width / 750;
                document.write('<meta name="viewport" content="width=750, minimum-scale = ' + phoneScale + ', maximum-scale = ' + phoneScale + ', target-densitydpi=device-dpi">');
            } else {
                document.write('<meta name="viewport" content="width=, target-densitydpi=device-dpi">');
            }
        } else {
            document.write('<meta name="viewport" content="width=750, user-scalable=no">');
        }
    </script>
    <script src="js/jquery-3.4.1.min.js" type="text/javascript"></script>
</head>

<body>
<div id="msgDetail">
    <div id="head">
        <div class="head_back" onclick="history.back();"></div>
        <p class="title">对方昵称</p>
    </div>

    <div id="content" style="margin-top: 88px;">

        <!-- <div id="mescroll" class="mescroll"> -->
        <div id="p-chat">
            <div class="scroll">
                <ul class="list" id="dataList">
                    <!--<li class="animated fadeIn user">
                        <img src="img/message/me.png" width="59" height="59" alt="">
                        <div class="detailMsg">
                            <p>你好？我有一个疑问想咨询</p>
                            <span></span>
                        </div>
                    </li>

                    <li class="animated fadeIn">
                        <img src="img/message/me.png" width="59" height="59" alt="">
                        <div class="detailMsg">
                            <p>6月21日大家伐要来寻吾哦</p>
                            <span></span>
                        </div>
                    </li>-->
                </ul>

                <div class="bar after">
                    <textarea id="textarea" rows="1" style="width: 560px;"></textarea>
                    <span class="icon-1" style="display: none;"></span>
                    <button id="sendMsg" onclick="sendMessage();" type="button">发送</button>
                </div>

            </div>
        </div>
        <!-- </div> -->

    </div>

</div>
<script src="https://cdn.ronghub.com/RongIMLib-2.5.0.min.js" type="text/javascript"></script>
<script src="https://cdn.ronghub.com/RongEmoji-2.2.7.min.js" type="text/javascript"></script>
<script src="js/rongcloud.js" type="text/javascript"></script>
<script src="js/common.js" type="text/javascript"></script>
<script type="text/javascript">
    shareMsg(); //分享


    const rongIMClient = RongIMClient.getInstance();
    const targetId = getQueryStringByName('targetId');
    const targetType = getQueryStringByName('targetType');

    const senderUsers = {};
    const currentUser = JSON.parse(localStorage.getItem('rong_current_user2'));
    const textMessage = new RongIMLib.TextMessage({content: '', extra: undefined, user: currentUser});

    $('.title').html(localStorage.getItem('rong_target_name'));
    $("#p-chat").css({'min-height': $(window).height() - 174});

    /**
     *收到消息时
     * @param message 消息对象
     */
    function onReceiveMessage(message) {
        updateMessageView([message], true, true);

        // 清除未读消息
        clearUnreadCount();
    }

    /**
     * 连接成功时
     */
    function onConnectSuccess() {
        // 获取历史消息
        getHistoryMessages(true);

        // 清除未读消息
        clearUnreadCount();
    }

    /**
     * 获取历史消息
     * @param scrollBottom 是否滚动到底部
     */
    function getHistoryMessages(scrollBottom) {
        RongIMLib.RongIMClient.getInstance().getHistoryMessages(parseInt(targetType), targetId, null, 20, {
            onSuccess: function (list, hasMsg) {
                // list => Message 数组。
                // hasMsg => 是否还有历史消息可以获取。
                console.log(list);
                console.log(hasMsg);
                updateMessageView(list, false, scrollBottom);
            },
            onError: function (error) {
                console.log('GetHistoryMessages, errorcode:' + error);
            }
        });
    }

    /**
     * 更新消息视图
     * @param list 消息列表
     * @param append 是否追加
     * @param scrollBottom 是否滚动到底部
     */
    function updateMessageView(list, append, scrollBottom) {
        for (let i = list.length - 1; i >= 0; i--) {
            let messageContent = getMessageContent(list[i]);

            let senderUser = list[i].content.user;
            let senderUserId = list[i].senderUserId;
            if (senderUsers[senderUserId] === undefined) {
                senderUsers[senderUserId] = senderUser;
            } else {
                senderUser = senderUsers[senderUserId];
            }

            let dataListHTML = '<li class="animated fadeIn ' + (senderUserId === currentUser.id ? 'user' : '') + '">' +
                '                   <img src="' + (senderUser ? senderUser['portrait'] : 'img/detail/head_img.png') + '" width="59" height="59" alt="">' +
                '                   <div class="detailMsg">' +
                '                       <p>' + messageContent + '</p>' +
                '                       <span></span>' +
                '                   </div>' +
                '                </li>';

            // 是否追加
            if (append) {
                $('#dataList').append(dataListHTML);
            } else {
                $('#dataList').prepend(dataListHTML);
            }
        }

        // 是否滚动到底部
        if (scrollBottom) {
            $('.scroll').scrollTop($('#dataList').height());
        }

        $('.scroll').scroll(function () {
            let scrollTop = $(this).scrollTop();

            if (0 === scrollTop) {
                getHistoryMessages(false);
            }
        });
    }

    /**
     * 清除未读消息
     */
    function clearUnreadCount() {
        rongIMClient.clearUnreadCount(parseInt(targetType), targetId, {
            onSuccess: function () {
                // 清除未读消息成功
            },
            onError: function (error) {
                // error => 清除未读消息数错误码
            }
        });
    }

    /**
     * 发送消息
     */
    function sendMessage() {
        let content = $('#textarea').val();
        if ($.trim(content) === '') {
            return alert('不能发送空白消息');
        }

        // 消息内容
        textMessage.content = content;

        // 发送消息
        rongIMClient.sendMessage(parseInt(targetType), targetId, textMessage, {
            onSuccess: function (message) {
                // message 为发送的消息对象并且包含服务器返回的消息唯一 Id 和发送消息时间戳
                console.log('Send successfully');
                console.log(message);

                $('#textarea').val('');
                updateMessageView([message], true, true);
            },
            onError: function (errorCode, message) {
                console.log(message);
                switch (errorCode) {
                    case RongIMLib.ErrorCode.TIMEOUT:
                        console.log('发送失败: 超时');
                        break;
                    case RongIMLib.ErrorCode.UNKNOWN:
                        console.log('发送失败: 未知错误');
                        break;
                    case RongIMLib.ErrorCode.REJECTED_BY_BLACKLIST:
                        console.log('发送失败: 在黑名单中，无法向对方发送消息');
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_DISCUSSION:
                        console.log('发送失败: 不在讨论组中');
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_GROUP:
                        console.log('发送失败: 不在群组中');
                        break;
                    case RongIMLib.ErrorCode.NOT_IN_CHATROOM:
                        console.log('发送失败: 不在聊天室中');
                        break;
                }
            }
        }, false, content);
    }
</script>

</body>

</html>